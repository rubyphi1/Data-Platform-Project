from pathlib import Path
import pandas as pd
import numpy as np
from prefect import flow, task
from prefect_gcp.cloud_storage import GcsBucket
from random import randint
import fastparquet
from prefect_gcp import GcpCredentials
import os
from prefect.tasks import task_input_hash
from time import time
from datetime import timedelta
from google.cloud import bigquery
from datetime import datetime
from prefect_gcp.bigquery import BigQueryWarehouse

# gcp_credentials_block = GcpCredentials.load("zoom-gcp-creds")
# client = bigquery.Client(credentials=gcp_credentials_block.get_credentials_from_service_account())
# query = """
#     SELECT MAX(DataID) AS max_id
#     FROM `utopian-outlet-384405.data_project.taxi_rides` 
# """

# result = client.query(query)
# for row in result: 
#     max_id = int(row['max_id'])
#     print(max_id)
def get_today_id():
    today = datetime.now()
    month = today.month 
    year = today.year
    if month == 1:
        month = 12
        year = year -1
    else:
        month = month -1
    month = month -2
    id = int(f"{year}{month:02}")
    return month,year,id

def query_max_id(gcp_credentials_block) -> int:
    client = bigquery.Client(credentials=gcp_credentials_block.get_credentials_from_service_account())
    query = """
        SELECT MAX(DataID) AS max_id
        FROM `utopian-outlet-384405.data_project.taxi_rides` 
    """
    try :
        result = client.query(query)
        for row in result: 
            max_id = int(row['max_id'])
    except:
        max_id =0
    print(max_id)
    return max_id 


if __name__ == "__main__":    
    gcp_credentials_block = GcpCredentials.load("zoom-gcp-creds")
    month = get_today_id()[0] 
    year = get_today_id()[1]
    today_id = get_today_id()[2]
    print(month)
        
    max_id = query_max_id(gcp_credentials_block)



